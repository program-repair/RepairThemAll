{
    "bug_id": 87,
    "classification": {
        "singleLine": false
    },
    "commit": "004db804",
    "failing_tests": [
        "org.apache.jackrabbit.oak.query.SQL2ParserTest",
        "org.apache.jackrabbit.oak.plugins.index.property.OrderedIndexQueryTest",
        "org.apache.jackrabbit.oak.plugins.index.property.PropertyIndexQueryTest"
    ],
    "files": 2,
    "jira_id": "2021",
    "linesAdd": 194,
    "linesRem": 39,
    "nb_error": 2,
    "nb_failure": 1,
    "nb_skipped": 9,
    "nb_test": 1868,
    "patch": "diff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Expression.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Expression.java\nindex 782a543c2f..b34fb56337 100644\n--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Expression.java\n+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Expression.java\n@@ -17,6 +17,8 @@\n package org.apache.jackrabbit.oak.query.xpath;\n \n import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n \n import org.apache.jackrabbit.oak.query.SQL2Parser;\n import org.apache.jackrabbit.util.ISO9075;\n@@ -45,6 +47,15 @@ public static Expression and(Expression old, Expression add) {\n         return new Expression.AndCondition(old, add);\n     }\n     \n+    /**\n+     * Get the optimized expression.\n+     * \n+     * @return the optimized expression\n+     */\n+    Expression optimize() {\n+        return this;\n+    }\n+\n     /**\n      * Whether this is a condition.\n      * \n@@ -54,6 +65,43 @@ boolean isCondition() {\n         return false;\n     }\n     \n+    /**\n+     * Whether this is a or contains a full-text condition.\n+     * \n+     * @return true if it is\n+     */\n+    boolean containsFullTextCondition() {\n+        return false;\n+    }\n+    \n+    /**\n+     * Get the left-hand-side expression for equality conditions. \n+     * For example, for x=1, it is x. If it is not equality, return null.\n+     * \n+     * @return the left-hand-side expression, or null\n+     */        \n+    String getCommonLeftPart() {\n+        return null;\n+    }\n+    \n+    /**\n+     * Get the left hand side of an expression.\n+     * \n+     * @return the left hand side\n+     */\n+    Expression getLeft() {\n+        return null;\n+    }\n+    \n+    /**\n+     * Get the list of the right hand side of an expression.\n+     * \n+     * @return the list\n+     */\n+    List<Expression> getRight() {\n+        return null;\n+    }\n+\n     /**\n      * Pull an OR condition up to the right hand side of an AND condition.\n      * \n@@ -157,19 +205,24 @@ int getPrecedence() {\n             return precedence;\n         }\n              \n-        /**\n-         * Get the left-hand-side expression for equality conditions. \n-         * For example, for x=1, it is x. If it is not equality, return null.\n-         * \n-         * @return the left-hand-side expression, or null\n-         */        \n-        public String getCommonLeftPart() {\n+        @Override\n+        String getCommonLeftPart() {\n             if (!\"=\".equals(operator)) {\n                 return null;\n             }\n             return left.toString();\n         }\n         \n+        @Override\n+        Expression getLeft() {\n+            return left;\n+        }\n+        \n+        @Override\n+        List<Expression> getRight() {\n+            return Collections.singletonList(right);\n+        }\n+    \n         @Override\n         public String toString() {\n             String leftExpr;\n@@ -223,6 +276,11 @@ boolean isCondition() {\n             return true;\n         }\n         \n+        @Override\n+        Expression optimize() {\n+            return this;\n+        }\n+    \n     }\n     \n     /**\n@@ -243,16 +301,87 @@ boolean isCondition() {\n          */\n         @Override\n         public String getCommonLeftPart() {\n-            if (left instanceof Condition && right instanceof Condition) {\n-                String l = ((Condition) left).getCommonLeftPart();\n-                String r = ((Condition) right).getCommonLeftPart();\n+            String l = left.getCommonLeftPart();\n+            String r = right.getCommonLeftPart();\n             if (l != null && r != null && l.equals(r)) {\n                 return l;\n             }\n-            }\n             return null;\n         }\n         \n+        @Override\n+        Expression optimize() {\n+            Expression l = left.optimize();\n+            Expression r = right.optimize();\n+            if (l != left || r != right) {\n+                return new OrCondition(l, r).optimize();\n+            }\n+            String commonLeft = getCommonLeftPart();\n+            if (commonLeft == null) {\n+                return this;\n+            }\n+            // \"@x = 1 or @x = 2\" is converted to \"@x in (1, 2)\"\n+            ArrayList<Expression> list = new ArrayList<Expression>();\n+            list.addAll(left.getRight());\n+            list.addAll(right.getRight());\n+            Expression le = left.getLeft();\n+            InCondition in = new InCondition(le, list);\n+            return in.optimize();\n+        }\n+        \n+        @Override\n+        boolean containsFullTextCondition() {\n+            return left.containsFullTextCondition() || right.containsFullTextCondition();\n+        }\n+        \n+    }\n+    \n+    /**\n+     * An \"or\" condition.\n+     */\n+    static class InCondition extends Expression {\n+\n+        final Expression left;\n+        final List<Expression> list;\n+        \n+        InCondition(Expression left, List<Expression> list) {\n+            this.left = left;\n+            this.list = list;\n+        }\n+        \n+        @Override\n+        String getCommonLeftPart() {\n+            return left.toString();\n+        }\n+        \n+        @Override\n+        Expression getLeft() {\n+            return left;\n+        }\n+        \n+        @Override\n+        List<Expression> getRight() {\n+            return list;\n+        }\n+    \n+        @Override\n+        public String toString() {\n+            StringBuilder buff = new StringBuilder();\n+            buff.append(left).append(\" in(\");\n+            for (int i = 0; i < list.size(); i++) {\n+                if (i > 0) {\n+                    buff.append(\", \");\n+                }\n+                buff.append(list.get(i));\n+            }\n+            return buff.append(')').toString();\n+        }\n+    \n+        @Override\n+        boolean isCondition() {\n+            return true;\n+        }        \n+        \n     }\n     \n     /**\n@@ -264,6 +393,16 @@ public String getCommonLeftPart() {\n             super(left, \"and\", right, Expression.PRECEDENCE_AND);\n         }\n \n+        @Override\n+        Expression optimize() {\n+            Expression l = left.optimize();\n+            Expression r = right.optimize();\n+            if (l != left || r != right) {\n+                return new AndCondition(l, r);\n+            }\n+            return this;\n+        }\n+        \n         @Override\n         AndCondition pullOrRight() {\n             if (right instanceof OrCondition) {\n@@ -285,6 +424,11 @@ AndCondition pullOrRight() {\n             return this;\n         }\n         \n+        @Override\n+        boolean containsFullTextCondition() {\n+            return left.containsFullTextCondition() || right.containsFullTextCondition();\n+        }\n+        \n     }\n     \n     /**\n@@ -319,6 +463,11 @@ boolean isCondition() {\n             return true;\n         }\n         \n+        @Override\n+        boolean containsFullTextCondition() {\n+            return true;\n+        }\n+        \n         @Override\n         boolean isName() {\n             return left.isName();\n@@ -353,6 +502,11 @@ boolean isCondition() {\n             return true;\n         }\n \n+        @Override\n+        boolean containsFullTextCondition() {\n+            return true;\n+        }\n+        \n         @Override\n         boolean isName() {\n             return false;\ndiff --git a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java\nindex 05044299a3..6113c0cc09 100644\n--- a/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java\n+++ b/oak-core/src/main/java/org/apache/jackrabbit/oak/query/xpath/Statement.java\n@@ -20,7 +20,6 @@\n \n import org.apache.jackrabbit.oak.query.QueryImpl;\n import org.apache.jackrabbit.oak.query.xpath.Expression.AndCondition;\n-import org.apache.jackrabbit.oak.query.xpath.Expression.Contains;\n import org.apache.jackrabbit.oak.query.xpath.Expression.OrCondition;\n import org.apache.jackrabbit.oak.query.xpath.Expression.Property;\n \n@@ -29,8 +28,6 @@\n  */\n public class Statement {\n \n-    private String xpathQuery;\n-    \n     private boolean explain;\n     private boolean measure;\n     \n@@ -49,15 +46,18 @@\n     \n     private Expression where;\n \n-    private ArrayList<Order> orderList = new ArrayList<Order>();\n+    ArrayList<Order> orderList = new ArrayList<Order>();\n+    \n+    String xpathQuery;\n     \n     public Statement optimize() {\n-        if (explain || measure || orderList.size() > 0) {\n+        if (explain || measure) {\n             return this;\n         }\n         if (where == null) {\n             return this;\n         }\n+        where = where.optimize();\n         ArrayList<Expression> unionList = new ArrayList<Expression>();\n         addToUnionList(where, unionList);\n         if (unionList.size() == 1) {\n@@ -71,29 +71,22 @@ public Statement optimize() {\n             s.selectors = selectors;\n             s.columnList = columnList;\n             s.where = e;\n-            if (i == unionList.size() - 1) {\n-                s.xpathQuery = xpathQuery;\n-            }\n             if (union == null) {\n                 union = s;\n             } else {\n                 union = new UnionStatement(union.optimize(), s.optimize());\n             }\n         }\n+        union.orderList = orderList;\n+        union.xpathQuery = xpathQuery;\n         return union;\n     }\n     \n     private static void addToUnionList(Expression condition,  ArrayList<Expression> unionList) {\n-        if (condition instanceof OrCondition) {\n+        if (condition.containsFullTextCondition()) {\n+            // do not use union\n+        } else if (condition instanceof OrCondition) {\n             OrCondition or = (OrCondition) condition;\n-            if (or.getCommonLeftPart() != null) {\n-                // @x = 1 or @x = 2 \n-                // is automatically converted to \n-                // @x in (1, 2)\n-                // within the query engine\n-            } else if (or.left instanceof Contains && or.right instanceof Contains) {\n-                // do not optimize \"contains\"\n-            } else {\n             // conditions of type                \n             // @x = 1 or @y = 2\n             // or similar are converted to\n@@ -101,7 +94,6 @@ private static void addToUnionList(Expression condition,  ArrayList<Expression>\n             addToUnionList(or.left, unionList);\n             addToUnionList(or.right, unionList);\n             return;\n-            }\n         } else if (condition instanceof AndCondition) {\n             // conditions of type\n             // @a = 1 and (@x = 1 or @y = 2)\n@@ -111,21 +103,12 @@ private static void addToUnionList(Expression condition,  ArrayList<Expression>\n             and = and.pullOrRight();\n             if (and.right instanceof OrCondition) {\n                 OrCondition or = (OrCondition) and.right;\n-                if (or.getCommonLeftPart() != null) {\n-                    // @x = 1 or @x = 2 \n-                    // is automatically converted to \n-                    // @x in (1, 2)\n-                    // within the query engine                \n-                } else if (or.left instanceof Contains && or.right instanceof Contains) {\n-                    // do not optimize \"contains\"\n-                } else {\n                 // same as above, but with the added \"and\"\n                 addToUnionList(new AndCondition(and.left, or.left), unionList);\n                 addToUnionList(new AndCondition(and.left, or.right), unionList);\n                 return;\n             }\n         }\n-        }\n         unionList.add(condition);\n     }\n     \n@@ -255,7 +238,25 @@ public void setOriginalQuery(String xpathQuery) {\n         \n         @Override\n         public String toString() {\n-            return s1 + \" union \" + s2;\n+            StringBuilder buff = new StringBuilder();\n+            buff.append(s1).append(\" union \").append(s2);\n+            // order by ...\n+            if (orderList != null && !orderList.isEmpty()) {\n+                buff.append(\" order by \");\n+                for (int i = 0; i < orderList.size(); i++) {\n+                    if (i > 0) {\n+                        buff.append(\", \");\n+                    }\n+                    buff.append(orderList.get(i));\n+                }\n+            }\n+            // leave original xpath string as a comment\n+            if (xpathQuery != null) {\n+                buff.append(\" /* xpath: \");\n+                buff.append(xpathQuery);\n+                buff.append(\" */\");\n+            }\n+            return buff.toString();\n         }\n         \n     }\n",
    "project": "jackrabbit-oak",
    "buggy_compile_success": true,
    "buggy_test_success": false,
    "fixed_compile_success": true,
    "fixed_test_success": true
}