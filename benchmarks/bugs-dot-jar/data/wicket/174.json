{
    "bug_id": 174,
    "classification": {
        "singleLine": false
    },
    "commit": "1fb66533",
    "failing_tests": [
        "org.apache.wicket.protocol.http.servlet.ServletWebResponseTest"
    ],
    "files": 1,
    "jira_id": "5582",
    "linesAdd": 39,
    "linesRem": 20,
    "nb_error": 0,
    "nb_failure": 2,
    "nb_skipped": 2,
    "nb_test": 1641,
    "patch": "diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java\nindex e665aaf1db..e7e32d17a2 100644\n--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java\n+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java\n@@ -173,29 +173,39 @@ public String encodeURL(CharSequence url)\n \t{\n \t\tArgs.notNull(url, \"url\");\n \n+\t\tUrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();\n+\n+\t\tUrl originalUrl = Url.parse(url);\n+\n \t\t/*\n \t\t  WICKET-4645 - always pass absolute url to the web container for encoding\n \t\t  because when REDIRECT_TO_BUFFER is in use Wicket may render PageB when\n \t\t  PageA is actually the requested one and the web container cannot resolve\n \t\t  the base url properly\n \t\t */\n-\t\tUrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();\n-\t\tUrl relativeUrl = Url.parse(url);\n-\t\tString fullUrl = urlRenderer.renderFullUrl(relativeUrl);\n+\t\tString fullUrl = urlRenderer.renderFullUrl(originalUrl);\n \t\tString encodedFullUrl = httpServletResponse.encodeURL(fullUrl);\n-\t\tfinal String encodedRelativeUrl;\n+\n+\t\tfinal String encodedUrl;\n+\t\tif (originalUrl.isFull())\n+\t\t{\n+\t\t\tencodedUrl = encodedFullUrl;\n+\t\t}\n+\t\telse\n+\t\t{\n \t\t\tif (fullUrl.equals(encodedFullUrl))\n \t\t\t{\n-\t\t\t// no encoding happened so just reuse the relative url\n-\t\t\tencodedRelativeUrl = url.toString();\n+\t\t\t\t// no encoding happened so just reuse the original url\n+\t\t\t\tencodedUrl = url.toString();\n \t\t\t}\n \t\t\telse\n \t\t\t{\n \t\t\t\t// get the relative url with the jsessionid encoded in it\n \t\t\t\tUrl _encoded = Url.parse(encodedFullUrl);\n-\t\t\tencodedRelativeUrl = urlRenderer.renderRelativeUrl(_encoded);\n+\t\t\t\tencodedUrl = urlRenderer.renderRelativeUrl(_encoded);\n \t\t\t}\n-\t\treturn encodedRelativeUrl;\n+\t\t}\n+\t\treturn encodedUrl;\n \t}\n \n \t@Override\n@@ -203,29 +213,38 @@ public String encodeRedirectURL(CharSequence url)\n \t{\n \t\tArgs.notNull(url, \"url\");\n \n+\t\tUrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();\n+\n+\t\tUrl originalUrl = Url.parse(url);\n+\n \t\t/*\n-\t\t  WICKET-4854 - always pass absolute url to the web container for encoding\n-\t\t  because when REDIRECT_TO_BUFFER is in use Wicket may render PageB when\n-\t\t  PageA is actually the requested one and the web container cannot resolve\n-\t\t  the base url properly\n+\t\t * WICKET-4645 - always pass absolute url to the web container for encoding because when\n+\t\t * REDIRECT_TO_BUFFER is in use Wicket may render PageB when PageA is actually the requested\n+\t\t * one and the web container cannot resolve the base url properly\n \t\t */\n-\t\tUrlRenderer urlRenderer = new UrlRenderer(webRequest);\n-\t\tUrl relativeUrl = Url.parse(url);\n-\t\tString fullUrl = urlRenderer.renderFullUrl(relativeUrl);\n+\t\tString fullUrl = urlRenderer.renderFullUrl(originalUrl);\n \t\tString encodedFullUrl = httpServletResponse.encodeRedirectURL(fullUrl);\n-\t\tfinal String encodedRelativeUrl;\n+\n+\t\tfinal String encodedUrl;\n+\t\tif (originalUrl.isFull())\n+\t\t{\n+\t\t\tencodedUrl = encodedFullUrl;\n+\t\t}\n+\t\telse\n+\t\t{\n \t\t\tif (fullUrl.equals(encodedFullUrl))\n \t\t\t{\n-\t\t\t// no encoding happened so just reuse the relative url\n-\t\t\tencodedRelativeUrl = url.toString();\n+\t\t\t\t// no encoding happened so just reuse the original url\n+\t\t\t\tencodedUrl = url.toString();\n \t\t\t}\n \t\t\telse\n \t\t\t{\n \t\t\t\t// get the relative url with the jsessionid encoded in it\n \t\t\t\tUrl _encoded = Url.parse(encodedFullUrl);\n-\t\t\tencodedRelativeUrl = urlRenderer.renderRelativeUrl(_encoded);\n+\t\t\t\tencodedUrl = urlRenderer.renderRelativeUrl(_encoded);\n+\t\t\t}\n \t\t}\n-\t\treturn encodedRelativeUrl;\n+\t\treturn encodedUrl;\n \t}\n \n \t@Override\n",
    "project": "wicket"
}