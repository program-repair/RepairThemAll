{
    "bug_id": 20,
    "classification": {
        "singleLine": false
    },
    "commit": "1fc7bd7a",
    "failing_tests": [
        "org.apache.camel.processor.AsyncLoopCopyTest"
    ],
    "files": 1,
    "jira_id": "6667",
    "linesAdd": 14,
    "linesRem": 7,
    "nb_error": 0,
    "nb_failure": 1,
    "nb_skipped": 1,
    "nb_test": 4675,
    "patch": "diff --git a/camel-core/src/main/java/org/apache/camel/processor/LoopProcessor.java b/camel-core/src/main/java/org/apache/camel/processor/LoopProcessor.java\nindex df2baed383..89649b15be 100644\n--- a/camel-core/src/main/java/org/apache/camel/processor/LoopProcessor.java\n+++ b/camel-core/src/main/java/org/apache/camel/processor/LoopProcessor.java\n@@ -61,6 +61,10 @@ public boolean process(Exchange exchange, AsyncCallback callback) {\n             return true;\n         }\n         \n+        // we hold on to the original Exchange in case it's needed for copies\n+        final Exchange original = exchange;\n+        \n+        // per-iteration exchange\n         Exchange target = exchange;\n \n         // set the size before we start\n@@ -70,8 +74,9 @@ public boolean process(Exchange exchange, AsyncCallback callback) {\n         while (index.get() < count.get()) {\n \n             // and prepare for next iteration\n-            target = prepareExchange(exchange, index.get());\n-            boolean sync = process(target, callback, index, count);\n+            // if (!copy) target = exchange; else copy of original\n+            target = prepareExchange(exchange, index.get(), original);\n+            boolean sync = process(target, callback, index, count, original);\n \n             if (!sync) {\n                 LOG.trace(\"Processing exchangeId: {} is continued being processed asynchronously\", target.getExchangeId());\n@@ -94,7 +99,8 @@ public boolean process(Exchange exchange, AsyncCallback callback) {\n     }\n \n     protected boolean process(final Exchange exchange, final AsyncCallback callback,\n-                              final AtomicInteger index, final AtomicInteger count) {\n+                              final AtomicInteger index, final AtomicInteger count,\n+                              final Exchange original) {\n \n         // set current index as property\n         LOG.debug(\"LoopProcessor: iteration #{}\", index.get());\n@@ -116,10 +122,10 @@ public void done(boolean doneSync) {\n                 while (index.get() < count.get()) {\n \n                     // and prepare for next iteration\n-                    target = prepareExchange(exchange, index.get());\n+                    target = prepareExchange(exchange, index.get(), original);\n \n                     // process again\n-                    boolean sync = process(target, callback, index, count);\n+                    boolean sync = process(target, callback, index, count, original);\n                     if (!sync) {\n                         LOG.trace(\"Processing exchangeId: {} is continued being processed asynchronously\", target.getExchangeId());\n                         // the remainder of the routing slip will be completed async\n@@ -148,10 +154,11 @@ public void done(boolean doneSync) {\n      * @param index the index of the next iteration\n      * @return the exchange to use\n      */\n-    protected Exchange prepareExchange(Exchange exchange, int index) {\n+    protected Exchange prepareExchange(Exchange exchange, int index, Exchange original) {\n         if (copy) {\n             // use a copy but let it reuse the same exchange id so it appear as one exchange\n-            return ExchangeHelper.createCopy(exchange, true);\n+            // use the original exchange rather than the looping exchange (esp. with the async routing engine)\n+            return ExchangeHelper.createCopy(original, true);\n         } else {\n             ExchangeHelper.prepareOutToIn(exchange);\n             return exchange;\n",
    "project": "camel"
}