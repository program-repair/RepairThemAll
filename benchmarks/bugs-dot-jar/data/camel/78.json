{
    "bug_id": 78,
    "classification": {
        "singleLine": false
    },
    "commit": "36e7b668",
    "failing_tests": [
        "org.apache.camel.processor.aggregator.AggregateTimeoutTest",
        "org.apache.camel.impl.CamelPostProcessorHelperTest"
    ],
    "files": 4,
    "jira_id": "8125",
    "linesAdd": 44,
    "linesRem": 36,
    "nb_error": 3,
    "nb_failure": 1,
    "nb_skipped": 4,
    "nb_test": 5161,
    "patch": "diff --git a/camel-core/src/main/java/org/apache/camel/impl/CamelPostProcessorHelper.java b/camel-core/src/main/java/org/apache/camel/impl/CamelPostProcessorHelper.java\nindex 04dbc4d4f7..817a2f969c 100644\n--- a/camel-core/src/main/java/org/apache/camel/impl/CamelPostProcessorHelper.java\n+++ b/camel-core/src/main/java/org/apache/camel/impl/CamelPostProcessorHelper.java\n@@ -22,6 +22,7 @@\n \n import org.apache.camel.CamelContext;\n import org.apache.camel.CamelContextAware;\n+import org.apache.camel.Component;\n import org.apache.camel.Consume;\n import org.apache.camel.Consumer;\n import org.apache.camel.ConsumerTemplate;\n@@ -37,7 +38,6 @@\n import org.apache.camel.component.bean.BeanInfo;\n import org.apache.camel.component.bean.BeanProcessor;\n import org.apache.camel.component.bean.ProxyHelper;\n-import org.apache.camel.component.properties.PropertiesComponent;\n import org.apache.camel.processor.CamelInternalProcessor;\n import org.apache.camel.processor.UnitOfWorkProducer;\n import org.apache.camel.util.CamelContextHelper;\n@@ -227,17 +227,13 @@ public Object getInjectionValue(Class<?> type, String endpointUri, String endpoi\n     public Object getInjectionPropertyValue(Class<?> type, String propertyName, String propertyDefaultValue,\n                                             String injectionPointName, Object bean, String beanName) {\n         try {\n+            // enforce a properties component to be created if none existed\n+            CamelContextHelper.lookupPropertiesComponent(getCamelContext(), true);\n+\n             String key;\n             String prefix = getCamelContext().getPropertyPrefixToken();\n             String suffix = getCamelContext().getPropertySuffixToken();\n-\n-            if (prefix == null && suffix == null) {\n-                // if no custom prefix/suffix then use defaults\n-                prefix = PropertiesComponent.DEFAULT_PREFIX_TOKEN;\n-                suffix = PropertiesComponent.DEFAULT_SUFFIX_TOKEN;\n-            }\n-\n-            if (!propertyName.startsWith(prefix)) {\n+            if (!propertyName.contains(prefix)) {\n                 // must enclose the property name with prefix/suffix to have it resolved\n                 key = prefix + propertyName + suffix;\n             } else {\ndiff --git a/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java b/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java\nindex 256fc8cb7b..7eb7fe6285 100644\n--- a/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java\n+++ b/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java\n@@ -1458,23 +1457,8 @@ public String resolvePropertyPlaceholders(String text) throws Exception {\n         if (text != null && !text.startsWith(\"properties:\")) {\n             // No component, assume default tokens.\n             if (pc == null && text.contains(PropertiesComponent.DEFAULT_PREFIX_TOKEN)) {\n-\n-                // try to lookup component, as we may be initializing CamelContext itself\n-                Component existing = lookupPropertiesComponent();\n-                if (existing != null) {\n-                    if (existing instanceof PropertiesComponent) {\n-                        pc = (PropertiesComponent) existing;\n-                    } else {\n-                        // properties component must be expected type\n-                        throw new IllegalArgumentException(\"Found properties component of type: \" + existing.getClass() + \" instead of expected: \" + PropertiesComponent.class);\n-                    }\n-                }\n-\n-                if (pc == null) {\n-                    // create a default properties component to be used as there may be default values we can use\n-                    log.info(\"No existing PropertiesComponent has been configured, creating a new default PropertiesComponent with name: properties\");\n-                    pc = getComponent(\"properties\", PropertiesComponent.class);\n-                }\n+                // lookup existing properties component, or force create a new default component\n+                pc = (PropertiesComponent) CamelContextHelper.lookupPropertiesComponent(this, true);\n             }\n \n             if (pc != null && text.contains(pc.getPrefixToken())) {\n@@ -2111,7 +2095,7 @@ private void doStartCamel() throws Exception {\n \n         // eager lookup any configured properties component to avoid subsequent lookup attempts which may impact performance\n         // due we use properties component for property placeholder resolution at runtime\n-        Component existing = lookupPropertiesComponent();\n+        Component existing = CamelContextHelper.lookupPropertiesComponent(this, false);\n         if (existing != null) {\n             // store reference to the existing properties component\n             if (existing instanceof PropertiesComponent) {\n@@ -3075,16 +3059,12 @@ public DataFormatDefinition resolveDataFormatDefinition(String name) {\n         }\n     }\n \n+    /**\n+     * @deprecated use {@link org.apache.camel.util.CamelContextHelper#lookupPropertiesComponent(org.apache.camel.CamelContext, boolean)}\n+     */\n+    @Deprecated\n     protected Component lookupPropertiesComponent() {\n-        // no existing properties component so lookup and add as component if possible\n-        PropertiesComponent answer = (PropertiesComponent) hasComponent(\"properties\");\n-        if (answer == null) {\n-            answer = getRegistry().lookupByNameAndType(\"properties\", PropertiesComponent.class);\n-            if (answer != null) {\n-                addComponent(\"properties\", answer);\n-            }\n-        }\n-        return answer;\n+        return CamelContextHelper.lookupPropertiesComponent(this, false);\n     }\n \n     public ShutdownStrategy getShutdownStrategy() {\ndiff --git a/camel-core/src/main/java/org/apache/camel/model/ProcessorDefinitionHelper.java b/camel-core/src/main/java/org/apache/camel/model/ProcessorDefinitionHelper.java\nindex 87689a312f..5ba236b5d1 100644\n--- a/camel-core/src/main/java/org/apache/camel/model/ProcessorDefinitionHelper.java\n+++ b/camel-core/src/main/java/org/apache/camel/model/ProcessorDefinitionHelper.java\n@@ -31,6 +31,7 @@\n import org.apache.camel.Exchange;\n import org.apache.camel.spi.ExecutorServiceManager;\n import org.apache.camel.spi.RouteContext;\n+import org.apache.camel.util.CamelContextHelper;\n import org.apache.camel.util.IntrospectionSupport;\n import org.apache.camel.util.ObjectHelper;\n import org.slf4j.Logger;\n@@ -524,6 +525,9 @@ public static void resolvePropertyPlaceholders(RouteContext routeContext, Object\n                     String local = key.getLocalPart();\n                     Object value = processorDefinition.getOtherAttributes().get(key);\n                     if (value != null && value instanceof String) {\n+                        // enforce a properties component to be created if none existed\n+                        CamelContextHelper.lookupPropertiesComponent(routeContext.getCamelContext(), true);\n+\n                         // value must be enclosed with placeholder tokens\n                         String s = (String) value;\n                         String prefixToken = routeContext.getCamelContext().getPropertyPrefixToken();\ndiff --git a/camel-core/src/main/java/org/apache/camel/util/CamelContextHelper.java b/camel-core/src/main/java/org/apache/camel/util/CamelContextHelper.java\nindex ab829f6166..097ed29e76 100644\n--- a/camel-core/src/main/java/org/apache/camel/util/CamelContextHelper.java\n+++ b/camel-core/src/main/java/org/apache/camel/util/CamelContextHelper.java\n@@ -35,6 +35,7 @@\n import org.apache.camel.Exchange;\n import org.apache.camel.NoSuchBeanException;\n import org.apache.camel.NoSuchEndpointException;\n+import org.apache.camel.component.properties.PropertiesComponent;\n import org.apache.camel.spi.ClassResolver;\n import org.apache.camel.spi.RouteStartupOrder;\n import org.slf4j.Logger;\n@@ -477,4 +478,30 @@ public static int getRouteStartupOrder(CamelContext camelContext, String routeId\n         return 0;\n     }\n \n+    /**\n+     * Lookup the {@link org.apache.camel.component.properties.PropertiesComponent} from the {@link org.apache.camel.CamelContext}.\n+     * <p/>\n+     * @param camelContext the camel context\n+     * @param autoCreate whether to automatic create a new default {@link org.apache.camel.component.properties.PropertiesComponent} if no custom component\n+     *                   has been configured.\n+     * @return the properties component, or <tt>null</tt> if none has been defined, and auto create is <tt>false</tt>.\n+     */\n+    public static Component lookupPropertiesComponent(CamelContext camelContext, boolean autoCreate) {\n+        // no existing properties component so lookup and add as component if possible\n+        PropertiesComponent answer = (PropertiesComponent) camelContext.hasComponent(\"properties\");\n+        if (answer == null) {\n+            answer = camelContext.getRegistry().lookupByNameAndType(\"properties\", PropertiesComponent.class);\n+            if (answer != null) {\n+                camelContext.addComponent(\"properties\", answer);\n+            }\n+        }\n+        if (answer == null && autoCreate) {\n+            // create a default properties component to be used as there may be default values we can use\n+            LOG.info(\"No existing PropertiesComponent has been configured, creating a new default PropertiesComponent with name: properties\");\n+            answer = camelContext.getComponent(\"properties\", PropertiesComponent.class);\n+        }\n+        return answer;\n+    }\n+\n+\n }\n",
    "project": "camel"
}